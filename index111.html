<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>ระบบสำรวจสัตว์ งานสัตวแพทย์</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: "Sarabun", Arial, sans-serif; background:#f4f6fb; margin:0; }
    header { background:#fff; padding:20px; text-align:center; border-bottom:4px solid #2c3e90; }
    main { max-width:900px; margin:30px auto; background:#fff; padding:30px; border-radius:10px; box-shadow:0 6px 15px rgba(0,0,0,.1); }
    .center-list { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:15px; }
    .center-card { border:1px solid #ddd; border-radius:8px; padding:15px; text-align:center; background:#f9fafc; }
    .center-card button { margin-top:10px; padding:10px 18px; background:#2c3e90; color:#fff; border:none; border-radius:6px; cursor:pointer; }
    label { display:block; margin-top:10px; font-weight:600; }
    input, select { width:100%; padding:8px; margin-top:6px; box-sizing:border-box; }
    .pet-card { border:1px solid #ccc; padding:12px; margin-top:10px; border-radius:6px; background:#fff; }
    .pet-card input, .pet-card select { margin-top:8px; }
    footer { text-align:center; padding:15px; color:#666; font-size:14px; }
    .controls-row { display:flex; gap:10px; align-items:center; }
    @media (max-width:520px){ .controls-row{flex-direction:column;align-items:stretch;} }
    button[type="submit"]{ margin-top:15px;padding:10px 20px;background:#2c3e90;color:#fff;border:none;border-radius:6px; cursor:pointer; }
    .muted { color:#666; font-size:14px; margin-top:8px; }
  </style>
</head>
<body>

<header>
  <h1>กองสาธารณสุขและสิ่งแวดล้อม ฝ่ายบริการสาธารณสุข</h1>
  <h2>งานสัตวแพทย์ แบบสำรวจสัตว์ ปี 2569</h2>
</header>

<main>
  <h2 style="text-align:center">เลือกศูนย์บริการสาธารณสุขเพื่อเริ่มสำรวจ</h2>

  <div class="center-list" id="centerList">
    <div class="center-card">ศูนย์บริการสาธารณสุขศูนย์ที่ 1<br><button type="button" onclick="openForm(1)">เริ่มสำรวจ</button></div>
    <div class="center-card">ศูนย์บริการสาธารณสุขศูนย์ที่ 2<br><button type="button" onclick="openForm(2)">เริ่มสำรวจ</button></div>
    <div class="center-card">ศูนย์บริการสาธารณสุขศูนย์ที่ 3<br><button type="button" onclick="openForm(3)">เริ่มสำรวจ</button></div>
    <div class="center-card">ศูนย์บริการสาธารณสุขศูนย์ที่ 4<br><button type="button" onclick="openForm(4)">เริ่มสำรวจ</button></div>
    <div class="center-card">ศูนย์บริการสาธารณสุขศูนย์ที่ 5<br><button type="button" onclick="openForm(5)">เริ่มสำรวจ</button></div>
    <div class="center-card">ศูนย์บริการสาธารณสุขศูนย์ที่ 6<br><button type="button" onclick="openForm(6)">เริ่มสำรวจ</button></div>
    <div class="center-card">ศูนย์บริการสาธารณสุขศูนย์ที่ 7<br><button type="button" onclick="openForm(7)">เริ่มสำรวจ</button></div>
  </div>

  <div id="formSection" style="display:none; margin-top:30px;">
    <h2>แบบฟอร์มสำรวจสัตว์</h2>
    <p id="centerLabel" style="font-weight:bold;color:#2c3e90"></p>

    <form id="surveyForm" novalidate>
      <input type="hidden" id="centerId" name="centerId">

      <label for="year">ปีงบประมาณ</label>
      <input type="number" id="year" name="year" value="2569" required min="2500" max="3000">

      <label for="animalType">ประเภทสัตว์</label>
      <select id="animalType" name="animalType" required>
        <option value="">-- เลือก --</option>
        <option>สุนัข</option><option>แมว</option><option>โค</option><option>เป็ด</option><option>ไก่</option><option>สุกร</option><option>นก</option><option>แพะ</option><option>ม้า</option><option>อื่น ๆ</option>
      </select>

      <div class="controls-row">
        <div style="flex:1">
          <label for="petQty">จำนวนสัตว์เลี้ยง</label>
          <input type="number" id="petQty" name="petQty" min="0" max="50" value="0" aria-describedby="petQtyHelp">
          <div id="petQtyHelp" class="muted">จำกัดสูงสุด 50 ตัว หากต้องการมากกว่านี้ ให้ทำหลายรายการ</div>
        </div>
      </div>

      <div id="petList" aria-live="polite"></div>

      <label for="recorderName">ผู้บันทึกข้อมูล</label>
      <input type="text" id="recorderName" name="recorderName" required>

      <label for="phone">เบอร์โทรศัพท์</label>
      <input type="tel" id="phone" name="phone" pattern="[0-9+\-\s()]{0,25}" placeholder="ตัวอย่าง: 098-765-4321">

      <button type="submit">บันทึกข้อมูล</button>
    </form>

    <p id="status" aria-live="assertive" style="margin-top:15px;color:#2c3e90;font-weight:600"></p>
  </div>
</main>

<footer>
  © เทศบาลนครอุบลราชธานี | กองสาธารณสุขและสิ่งแวดล้อม งานสัตวแพทย์
</footer>

<script>
(function(){
  const centerNames = {
    1:'ศูนย์บริการสาธารณสุขศูนย์ที่ 1',
    2:'ศูนย์บริการสาธารณสุขศูนย์ที่ 2',
    3:'ศูนย์บริการสาธารณสุขศูนย์ที่ 3',
    4:'ศูนย์บริการสาธารณสุขศูนย์ที่ 4',
    5:'ศูนย์บริการสาธารณสุขศูนย์ที่ 5',
    6:'ศูนย์บริการสาธารณสุขศูนย์ที่ 6',
    7:'ศูนย์บริการสาธารณสุขศูนย์ที่ 7'
  };

  const formSection = document.getElementById('formSection');
  const centerIdInput = document.getElementById('centerId');
  const centerLabel = document.getElementById('centerLabel');
  const petQtyInput = document.getElementById('petQty');
  const petList = document.getElementById('petList');
  const surveyForm = document.getElementById('surveyForm');
  const statusEl = document.getElementById('status');

  window.openForm = function(center) {
    formSection.style.display = 'block';
    centerIdInput.value = center;
    centerLabel.innerText = 'ศูนย์ที่กำลังบันทึกข้อมูล: ' + (centerNames[center] || ('ศูนย์ ' + center));
    // focus recorder for faster data entry
    document.getElementById('recorderName').focus();
  };

  petQtyInput.addEventListener('input', syncPetList);

  function clampQty(q){
    const max = parseInt(petQtyInput.max,10) || 50;
    if(q > max) return max;
    if(q < 0) return 0;
    return q;
  }

  function syncPetList(){
    let qty = parseInt(petQtyInput.value || 0, 10);
    if (isNaN(qty)) qty = 0;
    qty = clampQty(qty);
    petQtyInput.value = qty;
    while (petList.children.length < qty) petList.appendChild(createPetCard(petList.children.length+1));
    while (petList.children.length > qty) petList.removeChild(petList.lastChild);
  }

  function createPetCard(no) {
    const d = document.createElement('div');
    d.className = 'pet-card';
    // generate unique ids for inputs
    const idBase = 'pet' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,6);
    d.innerHTML = `
      <strong>สัตว์ตัวที่ ${no}</strong>
      <label for="${idBase}_name">ชื่อสัตว์</label>
      <input id="${idBase}_name" class="petName" name="petName_${no}" placeholder="ชื่อสัตว์" required>

      <label for="${idBase}_gender">เพศ</label>
      <select id="${idBase}_gender" class="gender" name="gender_${no}">
        <option>ผู้</option><option>เมีย</option><option>ไม่ระบุ</option>
      </select>

      <div class="controls-row">
        <div style="flex:1">
          <label for="${idBase}_age_y">อายุ (ปี)</label>
          <input id="${idBase}_age_y" type="number" class="ageYear" name="ageYear_${no}" placeholder="0" min="0">
        </div>
        <div style="flex:1">
          <label for="${idBase}_age_m">อายุ (เดือน)</label>
          <input id="${idBase}_age_m" type="number" class="ageMonth" name="ageMonth_${no}" placeholder="0" min="0" max="11">
        </div>
      </div>

      <label for="${idBase}_color">สี / ตำหนิ</label>
      <input id="${idBase}_color" class="color" name="color_${no}" placeholder="สี / ตำหนิ">

      <label for="${idBase}_ster">การทำหมัน</label>
      <select id="${idBase}_ster" class="sterilization" name="sterilization_${no}">
        <option>ยังไม่ทำหมัน</option><option>ทำหมันแล้ว</option><option>ฉีดยาคุม</option>
      </select>

      <label for="${idBase}_rab">การฉีดพิษสุนัขบ้า</label>
      <select id="${idBase}_rab" class="rabies" name="rabies_${no}">
        <option>เคยฉีด</option><option>ไม่เคยฉีด</option>
      </select>

      <label for="${idBase}_raising">ลักษณะการเลี้ยง</label>
      <select id="${idBase}_raising" class="raising" name="raising_${no}">
        <option>เลี้ยงในพื้นที่จำกัดตลอดเวลา</option>
        <option>เลี้ยงในพื้นที่จำกัดบางเวลา</option>
        <option>เลี้ยงแบบปล่อยตลอดเวลา</option>
      </select>

      <label for="${idBase}_loc">สถานที่พบ/เลี้ยง</label>
      <select id="${idBase}_loc" class="location" name="location_${no}">
        <option>บ้านพักอาศัย</option><option>สถานที่ราชการ</option><option>วัด</option><option>ตลาด</option><option>บริเวณหมู่บ้าน</option><option>สถานที่เอกชน</option>
      </select>
    `;
    return d;
  }

  surveyForm.addEventListener('submit', function(e){
    e.preventDefault();

    // check required fields in the form (including dynamically created pet inputs)
    if (!surveyForm.checkValidity()) {
      surveyForm.reportValidity();
      return;
    }

    const pets = Array.from(document.querySelectorAll('.pet-card'));
    if (pets.length === 0) {
      alert('กรุณาระบุจำนวนสัตว์');
      return;
    }

    const records = pets.map((p, i) => {
      const get = (sel) => {
        const el = p.querySelector(sel);
        return el ? el.value : '';
      };
      return {
        center: centerIdInput.value || '',
        centerName: centerLabel.innerText || '',
        year: document.getElementById('year').value || '',
        animalType: document.getElementById('animalType').value || '',
        animalName: get('.petName') || `ตัวที่ ${i+1}`,
        gender: get('.gender'),
        ageYear: get('.ageYear'),
        ageMonth: get('.ageMonth'),
        color: get('.color'),
        sterilization: get('.sterilization'),
        rabies: get('.rabies'),
        raising: get('.raising'),
        location: get('.location'),
        recorder: document.getElementById('recorderName').value || '',
        phone: document.getElementById('phone').value || ''
      };
    });

    exportCSV(records);

    statusEl.innerText = `บันทึกข้อมูล ${records.length} รายการเรียบร้อย`;
    // reset only the relevant inputs, but keep selected center
    document.getElementById('year').value = '2569';
    document.getElementById('animalType').value = '';
    document.getElementById('recorderName').value = '';
    document.getElementById('phone').value = '';
    petList.innerHTML = '';
    petQtyInput.value = 0;
  });

  function csvEscape(v){
    if (v === null || typeof v === 'undefined') return '""';
    const s = String(v).replace(/"/g,'""');
    return `"${s}"`;
  }

  function exportCSV(data){
    if (!data || data.length === 0) return;
    const headerKeys = Object.keys(data[0]);
    const header = headerKeys.join(',');
    const rows = data.map(r => headerKeys.map(k => csvEscape(r[k])).join(','));
    // add BOM for Excel + UTF-8
    const csvContent = '\uFEFF' + [header, ...rows].join("\n");
    const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    // filename includes center id and timestamp
    const centerPart = (centerIdInput.value ? ('center' + centerIdInput.value + '_') : '');
    a.download = `${centerPart}animal_survey_${Date.now()}.csv`;
    document.body.appendChild(a);
    a.click();
    // cleanup after a short delay to ensure download starts in all browsers
    setTimeout(function(){
      URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }, 1000);
  }

  // initialize UI
  // no center selected on load
})();
</script>

</body>
</html>
